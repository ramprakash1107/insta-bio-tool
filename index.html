<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Private Chat + Audio Call</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:#000;
  color:#fff;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* LOGIN */
#loginBox{ padding:20px; }
#loginBox input,#loginBox button{
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:12px;
  border:none;
  font-size:16px;
}
#loginBox input{ background:#111;color:#fff; }
#loginBox button{ background:#1d9bf0;color:#fff;font-weight:bold; }

/* CHAT */
#chatScreen{ display:none; flex:1; flex-direction:column; }
header{
  padding:10px;
  border-bottom:1px solid #222;
  position:relative;
}
#callBtn{
  position:absolute;
  right:70px;
  top:10px;
  background:#0f9d58;
  border:none;
  color:#fff;
  padding:6px 10px;
  border-radius:6px;
}
#leaveBtn{
  position:absolute;
  right:10px;
  top:10px;
  background:#e53935;
  border:none;
  color:#fff;
  padding:6px 10px;
  border-radius:6px;
}
#chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
}
.msg{
  max-width:75%;
  padding:10px 14px;
  margin:6px 0;
  border-radius:18px;
}
.left{ background:#1e1e1e; align-self:flex-start; }
.right{ background:#1d9bf0; align-self:flex-end; }

footer{
  display:flex;
  gap:8px;
  padding:8px;
  border-top:1px solid #222;
}
footer input{
  flex:1;
  padding:12px;
  border-radius:20px;
  border:none;
  background:#1e1e1e;
  color:#fff;
}
footer button{
  padding:0 16px;
  border-radius:50%;
  border:none;
  background:#1d9bf0;
  color:#fff;
}

/* AUDIO CALL SCREEN */
#callScreen{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:9999;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
#callScreen h2{ margin-bottom:30px; }
#endCall{
  background:#e53935;
  border:none;
  color:#fff;
  padding:14px 26px;
  border-radius:30px;
  font-size:16px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>üîê Private Chat</h2>
  <input id="username" placeholder="Your name">
  <input id="roomcode" placeholder="Room code">
  <button id="enterBtn">Enter Chat</button>
</div>

<!-- CHAT -->
<div id="chatScreen">
  <header>
    <span id="roomName"></span>
    <button id="callBtn">üìû Call</button>
    <button id="leaveBtn">Leave</button>
  </header>

  <div id="chat"></div>

  <footer>
    <input id="msg" placeholder="Message...">
    <button id="sendBtn">‚û§</button>
  </footer>
</div>

<!-- AUDIO CALL -->
<div id="callScreen">
  <h2 id="callStatus">üîä Audio Call</h2>
  <button id="endCall">End Call</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, onValue, remove }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

/* üî• FIREBASE CONFIG (aapka hi) */
const firebaseConfig = {
  apiKey: "AIzaSyARuO_pN2vdYrVKYkKHHaNys7WI8HqM6I4",
  authDomain: "friendchat-43941.firebaseapp.com",
  databaseURL: "https://friendchat-43941-default-rtdb.firebaseio.com",
  projectId: "friendchat-43941",
  storageBucket: "friendchat-43941.appspot.com",
  messagingSenderId: "1026542245723",
  appId: "1:1026542245723:web:b892bfcc1d2358a018ac7e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ELEMENTS */
const loginBox = document.getElementById("loginBox");
const chatScreen = document.getElementById("chatScreen");
const chatDiv = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const enterBtn = document.getElementById("enterBtn");
const sendBtn = document.getElementById("sendBtn");
const leaveBtn = document.getElementById("leaveBtn");
const callBtn = document.getElementById("callBtn");

const callScreen = document.getElementById("callScreen");
const callStatus = document.getElementById("callStatus");
const endCall = document.getElementById("endCall");

let user="", room="", chatRef;

/* CHAT ENTER */
enterBtn.onclick=()=>{
  user=username.value.trim();
  room=roomcode.value.trim();
  if(!user||!room) return alert("Name & Room required");
  loginBox.style.display="none";
  chatScreen.style.display="flex";
  roomName.textContent="Room: "+room;
  chatRef=ref(db,`rooms/${room}/messages`);

  onChildAdded(chatRef,s=>{
    const m=s.val();
    const d=document.createElement("div");
    d.className="msg "+(m.user===user?"right":"left");
    d.innerHTML=m.user===user?m.text:`<b>${m.user}</b><br>${m.text}`;
    chatDiv.appendChild(d);
    chatDiv.scrollTop=chatDiv.scrollHeight;
  });
};

/* SEND MSG */
sendBtn.onclick=()=>{
  if(!msgInput.value.trim()) return;
  push(chatRef,{user,text:msgInput.value});
  msgInput.value="";
};

/* ================= AUDIO CALL ================= */

let peer=null;
let localStream=null;
let isCaller=false;

const rtcConfig={ iceServers:[{urls:"stun:stun.l.google.com:19302"}] };

/* START CALL */
callBtn.onclick=async()=>{
  isCaller=true;
  callScreen.style.display="flex";
  callStatus.textContent="üìû Calling...";

  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  peer=new RTCPeerConnection(rtcConfig);

  localStream.getTracks().forEach(t=>peer.addTrack(t,localStream));

  peer.onicecandidate=e=>{
    if(e.candidate){
      push(ref(db,`rooms/${room}/call/iceCaller`),e.candidate.toJSON());
    }
  };

  const offer=await peer.createOffer();
  await peer.setLocalDescription(offer);
  set(ref(db,`rooms/${room}/call/offer`),offer);
};

/* RECEIVE CALL */
onValue(ref(db,`rooms/${room}/call/offer`),async snap=>{
  if(!snap.exists()||peer||isCaller) return;

  if(!confirm("üìû Incoming Audio Call ‚Äì Accept?")) return;

  callScreen.style.display="flex";
  callStatus.textContent="üîä Call Connected";

  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  peer=new RTCPeerConnection(rtcConfig);
  localStream.getTracks().forEach(t=>peer.addTrack(t,localStream));

  peer.ontrack=e=>{
    const audio=document.createElement("audio");
    audio.srcObject=e.streams[0];
    audio.autoplay=true;
  };

  peer.onicecandidate=e=>{
    if(e.candidate){
      push(ref(db,`rooms/${room}/call/iceReceiver`),e.candidate.toJSON());
    }
  };

  await peer.setRemoteDescription(snap.val());
  const ans=await peer.createAnswer();
  await peer.setLocalDescription(ans);
  set(ref(db,`rooms/${room}/call/answer`),ans);
});

/* ANSWER RECEIVE */
onValue(ref(db,`rooms/${room}/call/answer`),async snap=>{
  if(snap.exists()&&peer&&!peer.currentRemoteDescription){
    await peer.setRemoteDescription(snap.val());
    callStatus.textContent="üîä Call Connected";
  }
});

/* ICE EXCHANGE */
onChildAdded(ref(db,`rooms/${room}/call/iceCaller`),snap=>{
  if(peer&&!isCaller) peer.addIceCandidate(new RTCIceCandidate(snap.val()));
});
onChildAdded(ref(db,`rooms/${room}/call/iceReceiver`),snap=>{
  if(peer&&isCaller) peer.addIceCandidate(new RTCIceCandidate(snap.val()));
});

/* END CALL */
endCall.onclick=()=>{
  if(peer) peer.close();
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  peer=null; localStream=null; isCaller=false;
  remove(ref(db,`rooms/${room}/call`));
  callScreen.style.display="none";
};

leaveBtn.onclick=()=>location.reload();
</script>
</body>
</html>
