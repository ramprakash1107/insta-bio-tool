<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private DM Chat</title>
<style>
body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont;background:#0d0d0d;color:#fff;display:flex;flex-direction:column;height:100vh;}
#loginBox{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:20px;}
#loginBox input,#loginBox button{padding:12px;margin:8px;width:250px;border-radius:12px;border:none;font-size:16px;}
#loginBox input{background:#222;color:#fff;}
#loginBox button{background:#1d9bf0;color:#fff;font-weight:bold;cursor:pointer;}
#loginBox button:hover{background:#0c7cd5;}
#chatScreen{display:none;flex:1;flex-direction:row;height:100%;}
#userList{width:200px;border-right:1px solid #222;overflow-y:auto;background:#111;}
#userList div{padding:10px;border-bottom:1px solid #222;cursor:pointer;}
#userList div:hover{background:#1d1d1d;}
#userList .active{background:#1d9bf0;color:#fff;}
#chatArea{flex:1;display:flex;flex-direction:column;}
header{flex-shrink:0;padding:12px;border-bottom:1px solid #222;background:#111;display:flex;justify-content:space-between;align-items:center;}
#chat{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;}
.msg{max-width:70%;padding:10px 14px;margin:6px 0;border-radius:18px;word-wrap:break-word;font-size:15px;opacity:0;transition:0.3s;}
.left{align-self:flex-start;background:#1e1e1e;border-bottom-left-radius:4px;}
.right{align-self:flex-end;background:#1d9bf0;color:#fff;border-bottom-right-radius:4px;}
.seen{font-size:11px;color:#aaa;text-align:right;margin-right:8px;}
footer{flex-shrink:0;display:flex;gap:8px;padding:8px;border-top:1px solid #222;background:#111;}
footer input{flex:1;padding:12px;border-radius:20px;border:none;background:#1e1e1e;color:#fff;font-size:14px;}
footer button{padding:0 16px;border-radius:50%;border:none;background:#1d9bf0;color:#fff;font-size:18px;cursor:pointer;}
#typing{font-size:12px;color:#aaa;padding-left:10px;height:16px;font-style:italic;}
#leaveBtn{background:#e53935;border:none;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;cursor:pointer;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>üîê DM Chat</h2>
  <input id="username" placeholder="Enter your username">
  <button id="enterBtn">Enter Chat</button>
</div>

<!-- CHAT -->
<div id="chatScreen">
  <div id="userList"></div>
  <div id="chatArea">
    <header>
      <div id="chatWith">Select a user</div>
      <button id="leaveBtn">Leave</button>
    </header>
    <div id="chat"></div>
    <div id="typing"></div>
    <footer>
      <input id="msg" placeholder="Type a message...">
      <button id="sendBtn">‚û§</button>
    </footer>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue, set, remove, update } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyARuO_pN2vdYrVKYkKHHaNys7WI8HqM6I4",
  authDomain: "friendchat-43941.firebaseapp.com",
  databaseURL: "https://friendchat-43941-default-rtdb.firebaseio.com",
  projectId: "friendchat-43941",
  storageBucket: "friendchat-43941.firebasestorage.app",
  messagingSenderId: "1026542245723",
  appId: "1:1026542245723:web:b892bfcc1d2358a018ac7e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* DOM */
const loginBox=document.getElementById("loginBox");
const chatScreen=document.getElementById("chatScreen");
const userListDiv=document.getElementById("userList");
const chatDiv=document.getElementById("chat");
const typingDiv=document.getElementById("typing");
const chatWithDiv=document.getElementById("chatWith");
const enterBtn=document.getElementById("enterBtn");
const sendBtn=document.getElementById("sendBtn");
const leaveBtn=document.getElementById("leaveBtn");
const usernameInput=document.getElementById("username");
const msgInput=document.getElementById("msg");

let user="", selectedUser="", chatRef, typingRef, userRef;

/* ENTER */
enterBtn.addEventListener("click", async()=>{
  user=usernameInput.value.trim();
  if(!user){ alert("Enter username"); return; }

  const userCheckRef = ref(db,`users/${user}`);
  let exists=false;
  await onValue(userCheckRef,snap=>{if(snap.exists()) exists=true;},{onlyOnce:true});
  if(exists){ alert("Username exists! Try another."); return; }

  loginBox.style.display="none";
  chatScreen.style.display="flex";

  userRef=ref(db,`users/${user}`);
  set(userRef,true);

  // Listen for online users
  onValue(ref(db,"users"),snap=>{
    userListDiv.innerHTML="";
    snap.forEach(c=>{
      if(c.key!==user){
        const div=document.createElement("div");
        div.textContent=c.key;
        div.classList.toggle("active", c.key===selectedUser);
        div.onclick=()=>{
          selectedUser=c.key;
          Array.from(userListDiv.children).forEach(d=>d.classList.remove("active"));
          div.classList.add("active");
          openChat(selectedUser);
        }
        userListDiv.appendChild(div);
      }
    });
  });
});

/* OPEN CHAT */
function openChat(otherUser){
  chatDiv.innerHTML="";
  chatWithDiv.textContent="Chat with: "+otherUser;

  const path=[user,otherUser].sort().join("_");
  chatRef=ref(db,`private_chats/${path}/messages`);
  typingRef=ref(db,`private_chats/${path}/typing/${user}`);
  set(typingRef,false);

  onChildAdded(chatRef,snap=>{
    const m=snap.val();
    const div=document.createElement("div");
    div.className="msg "+(m.user===user?"right":"left"); // right for sender, left for receiver
    div.innerHTML=m.user===user?m.text:"<b>"+m.user+"</b><br>"+m.text;
    chatDiv.appendChild(div);
    setTimeout(()=>div.style.opacity=1,50);

    if(m.user!==user) update(ref(db,`private_chats/${path}/messages/${snap.key}`),{seen:true});
    if(m.user===user){
      const seenDiv=document.createElement("div");
      seenDiv.className="seen";
      seenDiv.textContent=m.seen?"Seen ‚úî‚úî":"Sent ‚úî";
      chatDiv.appendChild(seenDiv);
    }
    chatDiv.scrollTop=chatDiv.scrollHeight;
  });

  // Typing indicator
  onValue(ref(db,`private_chats/${path}/typing`),snap=>{
    let text="";
    snap.forEach(c=>{ if(c.key!==user && c.val()===true) text+=c.key+" typing... "; });
    typingDiv.textContent=text;
  });
}

/* SEND MESSAGE */
sendBtn.addEventListener("click",sendMessage);
msgInput.addEventListener("keypress",e=>{if(e.key==="Enter") sendMessage();});

function sendMessage(){
  if(!selectedUser) return alert("Select a user first!");
  const text=msgInput.value.trim(); if(!text) return;
  push(chatRef,{user,text,time:Date.now(),seen:false});
  msgInput.value="";
  set(typingRef,false);
}

/* TYPING */
msgInput.addEventListener("input",()=>{ if(typingRef) set(typingRef,msgInput.value.trim()!==""); });

/* LEAVE */
leaveBtn.addEventListener("click",()=>{
  remove(userRef);
  if(typingRef) remove(typingRef);
  location.reload();
});
</script>
</body>
</html>
