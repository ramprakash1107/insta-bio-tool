<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Private Friend Chat + Audio Call</title>

<style>
:root{ --vh:1vh; }
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:#000;
  color:#fff;
  height:calc(var(--vh)*100);
  display:flex;
  flex-direction:column;
}

/* LOGIN */
#loginBox{ padding:20px; }
#loginBox h2{margin-bottom:5px;}
#credit{font-size:12px;color:#777;margin-bottom:15px;}
#loginBox input,#loginBox button{
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:12px;
  border:none;
  font-size:16px;
}
#loginBox input{background:#111;color:#fff;}
#loginBox button{
  background:#1d9bf0;
  color:#fff;
  font-weight:bold;
}

/* CHAT SCREEN */
#chatScreen{
  display:none;
  flex:1;
  flex-direction:column;
  min-height:0;
}

/* HEADER */
header{
  flex-shrink:0;
  padding:10px;
  border-bottom:1px solid #222;
  background:#000;
  position:relative;
}
#roomName{font-weight:600;}
#online{font-size:12px;color:#aaa;}

#callBtn{
  position:absolute;
  right:70px;
  top:10px;
  background:#0f9d58;
  border:none;
  color:#fff;
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
}
#leaveBtn{
  position:absolute;
  right:10px;
  top:10px;
  background:#e53935;
  border:none;
  color:#fff;
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
}

/* CHAT AREA */
#chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
}

/* MESSAGE */
.msg{
  max-width:75%;
  padding:10px 14px;
  margin:6px 0;
  border-radius:18px;
  word-wrap:break-word;
  font-size:15px;
}
.left{
  align-self:flex-start;
  background:#1e1e1e;
  border-bottom-left-radius:4px;
}
.right{
  align-self:flex-end;
  background:#1d9bf0;
  color:#fff;
  border-bottom-right-radius:4px;
}
.seen{
  font-size:11px;
  color:#aaa;
  text-align:right;
  margin-right:8px;
}

/* TYPING */
#typing{
  font-size:12px;
  color:#aaa;
  padding-left:10px;
  height:16px;
}

/* FOOTER */
footer{
  flex-shrink:0;
  display:flex;
  gap:8px;
  padding:8px;
  border-top:1px solid #222;
  background:#000;
}
footer input{
  flex:1;
  padding:12px;
  border-radius:20px;
  border:none;
  background:#1e1e1e;
  color:#fff;
  font-size:14px;
}
footer button{
  padding:0 16px;
  border-radius:50%;
  border:none;
  background:#1d9bf0;
  color:#fff;
  font-size:18px;
}

/* AUDIO CALL SCREEN */
#callScreen{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:9999;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
#callScreen h2{margin-bottom:30px;}
#endCall{
  background:#e53935;
  border:none;
  color:#fff;
  padding:14px 26px;
  border-radius:30px;
  font-size:16px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>üîê Private Chat</h2>
  <div id="credit">Website by @rp_gupta_07</div>
  <input id="username" placeholder="Your name">
  <input id="roomcode" placeholder="Room code">
  <button id="enterBtn">Enter Chat</button>
</div>

<!-- CHAT -->
<div id="chatScreen">
  <header>
    <div id="roomName"></div>
    <div id="online"></div>
    <button id="callBtn">üìû Call</button>
    <button id="leaveBtn">Leave</button>
  </header>

  <div id="chat"></div>
  <div id="typing"></div>

  <footer>
    <input id="msg" placeholder="Message...">
    <button id="sendBtn">‚û§</button>
  </footer>
</div>

<!-- AUDIO CALL -->
<div id="callScreen">
  <h2 id="callStatus">üîä Audio Call</h2>
  <button id="endCall">End Call</button>
</div>

<script type="module">
function setVH(){
  document.documentElement.style.setProperty('--vh', window.innerHeight*0.01+'px');
}
setVH();
window.addEventListener('resize', setVH);

/* FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue, set, remove, update } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyARuO_pN2vdYrVKYkKHHaNys7WI8HqM6I4",
  authDomain: "friendchat-43941.firebaseapp.com",
  databaseURL: "https://friendchat-43941-default-rtdb.firebaseio.com",
  projectId: "friendchat-43941",
  storageBucket: "friendchat-43941.appspot.com",
  messagingSenderId: "1026542245723",
  appId: "1:1026542245723:web:b892bfcc1d2358a018ac7e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* DOM */
const loginBox = document.getElementById("loginBox");
const chatScreen = document.getElementById("chatScreen");
const chatDiv = document.getElementById("chat");
const typingDiv = document.getElementById("typing");
const roomName = document.getElementById("roomName");
const online = document.getElementById("online");
const enterBtn = document.getElementById("enterBtn");
const sendBtn = document.getElementById("sendBtn");
const leaveBtn = document.getElementById("leaveBtn");
const callBtn = document.getElementById("callBtn");
const usernameInput = document.getElementById("username");
const roomInput = document.getElementById("roomcode");
const msgInput = document.getElementById("msg");

const callScreen = document.getElementById("callScreen");
const callStatus = document.getElementById("callStatus");
const endCall = document.getElementById("endCall");

/* STATE */
let user="", room="", chatRef, typingRef, userRef;

/* AUDIO CALL STATE */
let peer=null, localStream=null, isCaller=false;
const rtcConfig={ iceServers:[{urls:"stun:stun.l.google.com:19302"}] };

/* ENTER CHAT */
enterBtn.addEventListener("click", async ()=>{
  user = usernameInput.value.trim();
  room = roomInput.value.trim();
  if(!user||!room){ alert("Name aur Room code likho"); return; }

  chatDiv.innerHTML="";
  typingDiv.textContent="";

  loginBox.style.display="none";
  chatScreen.style.display="flex";
  roomName.textContent="Room: "+room;

  chatRef = ref(db,`rooms/${room}/messages`);
  typingRef = ref(db,`rooms/${room}/typing/${user}`);
  userRef = ref(db,`rooms/${room}/users/${user}`);

  set(userRef,true);
  set(typingRef,false);

  /* ONLINE */
  onValue(ref(db,`rooms/${room}/users`), snap=>{
    online.textContent=(snap.exists()?Object.keys(snap.val()).length:0)+" online";
  });

  /* TYPING */
  onValue(ref(db,`rooms/${room}/typing`), snap=>{
    let t="";
    snap.forEach(c=>{
      if(c.key!==user && c.val()) t+=c.key+" typing...";
    });
    typingDiv.textContent=t;
  });

  /* MESSAGES */
  onChildAdded(chatRef, snap=>{
    const m=snap.val();
    const d=document.createElement("div");
    d.className="msg "+(m.user===user?"right":"left");
    d.innerHTML=m.user===user?m.text:`<b>${m.user}</b><br>${m.text}`;
    chatDiv.appendChild(d);
    chatDiv.scrollTop=chatDiv.scrollHeight;
  });

  setupCallListeners(); // üî¥ MOST IMPORTANT FIX
});

/* SEND MSG */
sendBtn.onclick=()=>{
  if(!msgInput.value.trim()) return;
  push(chatRef,{user,text:msgInput.value});
  msgInput.value="";
  set(typingRef,false);
};

msgInput.oninput=()=>set(typingRef,msgInput.value.trim()!=="");

/* AUDIO CALL */
callBtn.onclick=async()=>{
  isCaller=true;
  callScreen.style.display="flex";
  callStatus.textContent="üìû Calling...";

  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  peer=new RTCPeerConnection(rtcConfig);
  localStream.getTracks().forEach(t=>peer.addTrack(t,localStream));

  peer.onicecandidate=e=>{
    if(e.candidate) push(ref(db,`rooms/${room}/call/iceCaller`),e.candidate.toJSON());
  };

  const offer=await peer.createOffer();
  await peer.setLocalDescription(offer);
  set(ref(db,`rooms/${room}/call/offer`),offer);
};

/* CALL LISTENERS */
function setupCallListeners(){

  onValue(ref(db,`rooms/${room}/call/offer`), async snap=>{
    if(!snap.exists()||peer||isCaller) return;

    if(!confirm("üìû Incoming Audio Call Accept?")) return;

    callScreen.style.display="flex";
    callStatus.textContent="üîä Call Connected";

    localStream=await navigator.mediaDevices.getUserMedia({audio:true});
    peer=new RTCPeerConnection(rtcConfig);
    localStream.getTracks().forEach(t=>peer.addTrack(t,localStream));

    peer.ontrack=e=>{
      const a=document.createElement("audio");
      a.srcObject=e.streams[0];
      a.autoplay=true;
    };

    peer.onicecandidate=e=>{
      if(e.candidate) push(ref(db,`rooms/${room}/call/iceReceiver`),e.candidate.toJSON());
    };

    await peer.setRemoteDescription(snap.val());
    const ans=await peer.createAnswer();
    await peer.setLocalDescription(ans);
    set(ref(db,`rooms/${room}/call/answer`),ans);
  });

  onValue(ref(db,`rooms/${room}/call/answer`), async snap=>{
    if(snap.exists()&&peer&&!peer.currentRemoteDescription){
      await peer.setRemoteDescription(snap.val());
      callStatus.textContent="üîä Call Connected";
    }
  });

  onChildAdded(ref(db,`rooms/${room}/call/iceCaller`), snap=>{
    if(peer&&!isCaller) peer.addIceCandidate(new RTCIceCandidate(snap.val()));
  });

  onChildAdded(ref(db,`rooms/${room}/call/iceReceiver`), snap=>{
    if(peer&&isCaller) peer.addIceCandidate(new RTCIceCandidate(snap.val()));
  });
}

/* END CALL */
endCall.onclick=()=>{
  if(peer) peer.close();
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  peer=null; localStream=null; isCaller=false;
  remove(ref(db,`rooms/${room}/call`));
  callScreen.style.display="none";
};

leaveBtn.onclick=()=>location.reload();
</script>
</body>
</html>
